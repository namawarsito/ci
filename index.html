<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial;
        }

        .ui {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 8px;
            padding: 12px 18px;
            border-radius: 40px;
            backdrop-filter: blur(15px);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            z-index: 999;
        }

        .btn {
            padding: 8px 14px;
            border: none;
            border-radius: 50px;
            background: linear-gradient(45deg, #ff9800, #ff5722);
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .nama-hewan {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 20px;
            border-radius: 30px;
            backdrop-filter: blur(10px);
            background: rgba(0, 0, 0, 0.4);
            color: white;
            font-size: 22px;
            font-weight: bold;
            display: none;
            z-index: 999;
        }
    </style>
</head>

<body>

    <div class="nama-hewan" id="namaHewan"></div>

    <a-scene id="scene" embedded arjs="sourceType: webcam; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true;">
        <a-assets id="assetContainer"></a-assets>
        <a-entity camera></a-entity>
    </a-scene>

    <div class="ui" id="controlUI">
        <button class="btn" onclick="zoomOut()">âž–</button>
        <button class="btn" onclick="zoomIn()">âž•</button>

        <button class="btn" onclick="rotateUp()">â¬†</button>
        <button class="btn" onclick="rotateDown()">â¬‡</button>

        <button class="btn" onclick="rotateLeft()">âŸ²</button>
        <button class="btn" onclick="rotateRight()">âŸ³</button>

        <button class="btn" onclick="playSound()">ðŸ”Š</button>
    </div>

    <script>

        let currentObj = null;
        let currentScale = 0.5;
        let currentRotationY = 0;
        let currentRotationX = 0;
        let currentSound = null;
        let currentMinScale = 0.3;
        let currentMaxScale = 3;
        let initialDistance = null;

        const namaHewan = document.getElementById("namaHewan");
        const controlUI = document.getElementById("controlUI");
        const scene = document.getElementById("scene");
        const assetContainer = document.getElementById("assetContainer");

        fetch("data/animals.json")
            .then(res => res.json())
            .then(data => {

                data.forEach(animal => {

                    const modelAsset = document.createElement("a-asset-item");
                    modelAsset.setAttribute("id", animal.id + "Model");
                    modelAsset.setAttribute("src", animal.model);
                    assetContainer.appendChild(modelAsset);

                    const audio = document.createElement("audio");
                    audio.setAttribute("id", animal.id + "Sound");
                    audio.setAttribute("src", animal.suara);
                    audio.setAttribute("preload", "auto");
                    document.body.appendChild(audio);

                    const marker = document.createElement("a-marker");
                    marker.setAttribute("type", "pattern");
                    marker.setAttribute("url", animal.marker);

                    const entity = document.createElement("a-entity");
                    entity.setAttribute("id", animal.id + "Obj");
                    entity.setAttribute("gltf-model", "#" + animal.id + "Model");
                    entity.setAttribute("scale", `${animal.scale} ${animal.scale} ${animal.scale}`);

                    marker.appendChild(entity);
                    scene.appendChild(marker);

                    marker.addEventListener("markerFound", () => {
                        currentObj = entity;
                        currentScale = animal.scale;
                        currentRotationY = 0;
                        currentRotationX = 0;
                        currentSound = animal.id + "Sound";

                        currentMinScale = animal.minScale || 0.3;
                        currentMaxScale = animal.maxScale || 3;

                        namaHewan.innerText = animal.nama;
                        namaHewan.style.display = "block";
                        controlUI.style.display = "flex";

                        entity.setAttribute("rotation", "0 0 0");
                    });

                    marker.addEventListener("markerLost", () => {
                        namaHewan.style.display = "none";
                        controlUI.style.display = "none";
                        currentObj = null;
                        currentSound = null;
                    });

                });

            });

        function zoomIn() {
            if (!currentObj) return;
            currentScale += 0.1;
            if (currentScale > currentMaxScale)
                currentScale = currentMaxScale;
            currentObj.setAttribute("scale",
                `${currentScale} ${currentScale} ${currentScale}`);
        }

        function zoomOut() {
            if (!currentObj) return;
            currentScale -= 0.1;
            if (currentScale < currentMinScale)
                currentScale = currentMinScale;
            currentObj.setAttribute("scale",
                `${currentScale} ${currentScale} ${currentScale}`);
        }

        function rotateLeft() {
            if (!currentObj) return;
            currentRotationY -= 15;
            updateRotation();
        }

        function rotateRight() {
            if (!currentObj) return;
            currentRotationY += 15;
            updateRotation();
        }

        function rotateUp() {
            if (!currentObj) return;
            currentRotationX -= 15;
            if (currentRotationX < -90) currentRotationX = -90;
            updateRotation();
        }

        function rotateDown() {
            if (!currentObj) return;
            currentRotationX += 15;
            if (currentRotationX > 90) currentRotationX = 90;
            updateRotation();
        }

        function updateRotation() {
            currentObj.setAttribute("rotation",
                `${currentRotationX} ${currentRotationY} 0`);
        }

        function playSound() {
            if (!currentSound) return;
            const audio = document.getElementById(currentSound);
            audio.pause();
            audio.currentTime = 0;
            audio.play().catch(() => { });
        }

        document.addEventListener("touchstart", function (e) {
            if (e.touches.length == 2) {
                initialDistance = getDistance(e.touches);
            }
        });

        document.addEventListener("touchmove", function (e) {
            if (e.touches.length == 2 && currentObj) {

                let newDistance = getDistance(e.touches);
                let diff = newDistance - initialDistance;
                initialDistance = newDistance;

                currentScale += diff * 0.005;

                if (currentScale < currentMinScale)
                    currentScale = currentMinScale;

                if (currentScale > currentMaxScale)
                    currentScale = currentMaxScale;

                currentObj.setAttribute("scale",
                    `${currentScale} ${currentScale} ${currentScale}`);
            }
        });

        function getDistance(touches) {
            let dx = touches[0].clientX - touches[1].clientX;
            let dy = touches[0].clientY - touches[1].clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

    </script>

</body>

</html>